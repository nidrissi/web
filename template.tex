\documentclass[a4paper]{moderncv}

\usepackage{fontspec}
\setmainfont[Ligatures=TeX]{Carlito}
\usepackage{microtype}
\usepackage[super]{nth}

\usepackage[scale=0.9]{geometry}
\moderncvstyle{$style$}
\moderncvcolor{$color$}

% i18n
\usepackage{polyglossia}
\setmainlanguage{$mylang$}

% bib
\usepackage{csquotes}
\usepackage[defernumbers=true,sorting=ymdnt, maxnames=10]{biblatex}
% https://tex.stackexchange.com/questions/46868/biblatex-sorting-by-date
% sort by year, month, day, name, title
\DeclareSortingTemplate{ymdnt}{
  \sort{
    \field{presort}
  }
  \sort[final]{
    \field{sortkey}
  }
  \sort[direction=descending]{
    \field{sortyear}
    \field{year}
  }
  \sort[direction=descending]{
    \field[padside=left,padwidth=2,padchar=0]{month}
    \literal{00}
  }
  \sort[direction=descending]{
    \field[padside=left,padwidth=2,padchar=0]{day}
    \literal{00}
  }
  \sort{
    \field{sortname}
    \field{author}
    \field{editor}
    \field{translator}
    \field{sorttitle}
    \field{title}
  }
  \sort{
    \field{sorttitle}
  }
  \sort{
    \field[padside=left,padwidth=4,padchar=0]{volume}
    \literal{0000}
  }
}

% https://tex.stackexchange.com/a/354610
% add pagetotal to misc (preprints) entries
\renewbibmacro*{addendum+pubstate}{%
  \printfield{addendum}%
  \newunit\newblock
  \printfield{pubstate}
  \newunit\newblock
  \ifentrytype{misc}{\printfield{pagetotal}}{}}

% change localization of "master thesis"
\DefineBibliographyStrings{english}{mathesis = {Master's thesis}}

% bibresource
\addbibresource{mainbib.bib}

\title{$title$}
\firstname{$firstname$}
\familyname{$familyname$}
\address$for(address)${$address$}$endfor$
\email{$email$}
\extrainfo{\today}
\homepage{$homepage$}
\phone[fixed]{$phone$}

\begin{document}
\maketitle
\nocite{$for(nocite)$$nocite$$sep$,$endfor$}

$for(section)$
\section{$section.title$}

$for(section.content)$
  $if(section.content.entry)$
    \cventry
    $for(section.content.entry)$ {$section.content.entry$} $endfor$
  $endif$
  $if(section.content.subsection)$\subsection{$section.content.subsection$}$endif$
  $if(section.content.item)$
    \cvitem
    $for(section.content.item)$ {$section.content.item$} $endfor$
  $endif$
$endfor$

$for(section.bib)$
\printbibliography[title={$section.bib.title$}, keyword=$section.bib.key$, heading=subbibliography]
$endfor$

$endfor$

\end{document}

% Local Variables:
% TeX-engine: luatex
% End:
