\documentclass[a4paper]{moderncv}

\usepackage{fontspec}
\setmainfont[Ligatures=TeX]{Calibri}
\usepackage{microtype}
\usepackage[super]{nth}

\usepackage[scale=0.85]{geometry}
\moderncvstyle{classic}
\moderncvcolor{blue}

% i18n
\usepackage{polyglossia}
\setmainlanguage{$lang$}

% bib
\usepackage{csquotes}
\usepackage[defernumbers=true,sorting=nyt, maxnames=10]{biblatex}
\addbibresource{research.bib}

% timeline
\usepackage[firstyear=$moderntl.first$,lastyear=$moderntl.last$]{moderntimeline}

% https://tex.stackexchange.com/a/289622/14965
\makeatletter
\renewcommand{\tl@formatstartyear}[1]{
  \startyeartrue
  \tl@yearfraction{#1}
  \pgfmathsetmacro\tl@startfraction{(\tl@startyear-\tl@firstyear)/(\tl@lastyear-\tl@firstyear)}%
  \ifissince
    \xdef\tl@startlabel{\tl@since \tl@tmpmonth/\tl@tmpyear}
  \else
    \xdef\tl@startlabel{\tl@tmpmonth/\tl@tmpyear}
  \fi
}
\renewcommand{\tl@formatendyear}[1]{
  \startyearfalse%
  \tl@yearfraction{#1}
  \pgfmathsetmacro\tl@endfraction{(\tl@endyear-\tl@firstyear)/(\tl@lastyear-\tl@firstyear)}%
  \ifissince%
    \xdef\tl@endlabel{}
  \else
    \xdef\tl@endlabel{\tl@tmpmonth/\tl@tmpyear}
  \fi
}
\makeatother

\title{$title$}
\firstname{$firstname$}
\familyname{$familyname$}
\address$for(address)${$address$}$endfor$
\email{$email$}
\extrainfo{\today}
\homepage{$homepage$}

\begin{document}
\maketitle
\nocite{*}

$for(section)$
\section{$section.title$}

$for(section.entry)$
  $if(section.entry.content)$
    \$if(section.entry.timeline)$tl$if(section.entry.label)$label$endif$$endif$cventry
    $for(section.entry.content)$ {$section.entry.content$} $endfor$
  $endif$
  $if(section.entry.subsection)$\subsection{$section.entry.subsection$}$endif$
  $if(section.entry.item)$
    \cvitem
    $for(section.entry.item)$ {$section.entry.item$} $endfor$
  $endif$
$endfor$

$for(section.bib)$
\printbibliography[title={$section.bib.title$}, keyword=$section.bib.key$, heading=subbibliography]
$endfor$

$endfor$

\end{document}

% Local Variables:
% TeX-engine: luatex
% End:
