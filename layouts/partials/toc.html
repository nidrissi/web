<nav class="float-right card">
  <div class="card-body p-3">
    <h6 class="card-title">{{ i18n "contents" }}</h6>
    <div class="card-text">
      <ul class="list-unstyled mb-0">
        {{- $headers := findRE "<h[1-3].*?>(.|\n])+?</h[1-3]>" .Content -}}

        {{- range $i, $header := $headers -}}
        {{- $headerLevel := index (findRE "[1-3]" . 1) 0 -}}
        {{- $headerLevel := len (seq $headerLevel) -}}

        {{- $anchorID := ($header | plainify | htmlEscape | urlize) -}}

        {{- if ne $i 0 -}}
        {{- $prevHeaderLevel := index (findRE "[1-3]" (index $headers (sub $i 1)) 1) 0 -}}
        {{- $prevHeaderLevel := len (seq $prevHeaderLevel) -}}

        {{- if gt $headerLevel $prevHeaderLevel -}}
        {{- range seq (sub $headerLevel $prevHeaderLevel) -}}
        <ul class="list-unstyled ml-2 mb-0">
          {{- end -}}
          {{- end -}}

          {{- if lt $headerLevel $prevHeaderLevel -}}
          {{- range seq (sub $prevHeaderLevel $headerLevel) -}}
              </li></ul></li>
              {{- end -}}
              {{- end -}}

              {{- if eq $headerLevel $prevHeaderLevel -}}
              </li>
              {{- end -}}

              <li>
                <a href="#{{- $anchorID -}}">{{- $header | plainify | htmlEscape -}}</a>

                {{- if eq $i (sub (len $headers) 1) -}}
                {{- range seq (sub $prevHeaderLevel $headerLevel) -}}
              </li></ul></li>
              {{- end -}}
              {{- end -}}
              {{- else -}}
              <li>
                <a href="#{{- $anchorID -}}">{{- $header | plainify | htmlEscape -}}</a>
                {{- end -}}
                {{- end -}}

                {{- $firstHeaderLevel := len (seq (index (findRE "[1-3]" (index $headers 0) 1) 0)) -}}
                {{- $lastHeaderLevel := len (seq (index (findRE "[1-3]" (index $headers (sub (len $headers) 1)) 1) 0)) -}}
                {{- range seq (sub $lastHeaderLevel $firstHeaderLevel) -}}
              </li></ul></li>
              {{- end -}}
      </ul>
    </div>
  </div>
</nav>
